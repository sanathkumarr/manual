# .gitlab-ci.yml demonstrating: Variables, Stages, Script, Artifacts, Only/Except, Rules, Needs, Include, Environments, Templates

include:
  # Templates (local and remote examples)
  - local: 'ci/templates/node-common.yml'
  - remote: 'https://gitlab.com/example/shared-ci-templates/-/raw/main/nodejs.yml'

stages:
  - install
  - build
  - test
  - deploy

# Global variables
variables:
  CI: "true"
  NODE_ENV: "production"
  # Example template variable that included templates might consume
  DEFAULT_TIMEOUT: "30m"

####################
# INSTALL (uses Only)
####################
install:
  stage: install
  image: node:20-alpine
  before_script:
    - node -v && npm -v
  script:
    - npm install --no-audit --no-fund
    - npx update-browserslist-db@latest || true
  artifacts:
    paths:
      - node_modules/
    expire_in: 1h
  only:
    - main

####################
# BUILD (uses Needs + per-job Variables + Script + Artifacts)
####################
build:
  stage: build
  image: node:20-alpine
  needs:
    - job: install
      artifacts: true
  variables:
    # Job-specific variable (demonstrates per-job variables)
    DISABLE_ESLINT_PLUGIN: "true"
  before_script:
    - node -v && npm -v
  script:
    - npm install --no-audit --no-fund
    - npx update-browserslist-db@latest || true
    - npm run build
    - DISABLE_ESLINT_PLUGIN=true npm run build
  artifacts:
    paths:
      - build/
    expire_in: 1 day

####################
# TEST (uses Rules + Artifacts + Needs)
####################
test:
  stage: test
  image: node:20-alpine
  needs:
    - job: install
      artifacts: true
  variables:
    CI: "true"
  before_script:
    - node -v && npm -v
  # Rules used here to demonstrate flexible conditional execution:
  rules:
    # Run always for Merge Requests
    - if: '$CI_MERGE_REQUEST_ID'
      when: always
    # Run on branches except main
    - if: '$CI_COMMIT_BRANCH && $CI_COMMIT_BRANCH != "main"'
      when: always
    # Default: don't run on main via rules (explicit deny)
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: never
  script:
    - npm install --no-audit --no-fund
    - npm test -- --ci --watchAll=false --coverage
  artifacts:
    when: always
    paths:
      - coverage/
    expire_in: 1 week

####################
# PAGES / DEPLOY (uses Only, Environment, Artifacts)
####################
pages:
  stage: deploy
  image: node:20-alpine
  needs:
    - job: build
      artifacts: true
  before_script:
    - node -v && npm -v
  script:
    - rm -rf public && mkdir -p public
    - cp -r build/* public/
    - cp public/index.html public/404.html
    - touch public/.nojekyll
  artifacts:
    paths:
      - public
  environment:
    name: production
    url: "https://${CI_PROJECT_NAMESPACE}.gitlab.io/${CI_PROJECT_NAME}"
  only:
    - main

####################
# OPTIONAL: Example template job (showing Templates usage)
# This job demonstrates how an included template file may define jobs which you can override or extend.
####################
# Note: actual template file 'ci/templates/node-common.yml' should exist in repo.
